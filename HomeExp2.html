<!-- Card Size Inputs -->
<div style="margin-bottom: 10px;">
    <label for="card-width">Card Width:</label>
    <input type="number" id="card-width" value="300" min="100" onchange="updateCardSize()">
    <label for="card-height">Card Height:</label>
    <input type="number" id="card-height" value="200" min="100" onchange="updateCardSize()">
</div>

<!-- Card Container -->
<div id="card-container" style="width: 300px; height: 200px; position: relative; border: 1px solid #000; background-color: grey;">
    <!-- Background Image (Initially hidden) -->
    <img id="background" src="" style="width: 300px; height: 200px; position: absolute; top: 0; left: 0; display: none;">
</div>

<!-- Rest of your existing code remains the same -->

<script>
    // Existing JavaScript code

    // Function to update card size
    function updateCardSize() {
        const width = document.getElementById('card-width').value;
        const height = document.getElementById('card-height').value;

        const cardContainer = document.getElementById('card-container');
        cardContainer.style.width = width + 'px';
        cardContainer.style.height = height + 'px';

        const backgroundImage = document.getElementById('background');
        backgroundImage.style.width = width + 'px';
        backgroundImage.style.height = height + 'px';

        // Adjust positions and sizes of text fields relative to the new card size
        adjustTextFields(width, height);
    }

    // Function to adjust text fields when card size changes
    function adjustTextFields(newWidth, newHeight) {
        const textFields = document.querySelectorAll('#card-container > div');
        textFields.forEach(field => {
            // Get the original positions as percentages
            const leftPercent = (parseFloat(field.style.left) / parseFloat(cardContainer.style.width)) * 100;
            const topPercent = (parseFloat(field.style.top) / parseFloat(cardContainer.style.height)) * 100;

            // Update positions based on new dimensions
            field.style.left = (leftPercent / 100) * newWidth + 'px';
            field.style.top = (topPercent / 100) * newHeight + 'px';
        });
    }

    // Modify the makeDraggable function to use percentage-based positions
    function makeDraggable(element) {
        let offsetX = 0, offsetY = 0, mouseX = 0, mouseY = 0;

        element.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e.preventDefault();
            mouseX = e.clientX;
            mouseY = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e.preventDefault();
            isDragging = true;
            offsetX = mouseX - e.clientX;
            offsetY = mouseY - e.clientY;
            mouseX = e.clientX;
            mouseY = e.clientY;

            const cardRect = document.getElementById('card-container').getBoundingClientRect();

            let newTop = element.offsetTop - offsetY;
            let newLeft = element.offsetLeft - offsetX;

            // Ensure the element stays within the card container
            newTop = Math.max(0, Math.min(newTop, cardRect.height - element.offsetHeight));
            newLeft = Math.max(0, Math.min(newLeft, cardRect.width - element.offsetWidth));

            element.style.top = newTop + "px";
            element.style.left = newLeft + "px";
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
            setTimeout(() => { isDragging = false; }, 100);
        }
    }

    // Rest of your existing JavaScript code

    // Ensure that when the card size is restored, the text fields are correctly positioned
    function restoreCardState() {
        const savedState = localStorage.getItem('cardState');
        if (savedState) {
            document.getElementById('card-container').innerHTML = savedState;
            // Reapply editable and draggable functionality to the restored elements
            document.querySelectorAll('#card-container > div').forEach(el => {
                el.setAttribute('contenteditable', 'true');
                el.style.cursor = 'move';
                el.onclick = function() {
                    selectTextField(el);
                };
                makeDraggable(el);
            });

            // Update card size inputs to match the restored card size
            const cardContainer = document.getElementById('card-container');
            document.getElementById('card-width').value = parseFloat(cardContainer.style.width);
            document.getElementById('card-height').value = parseFloat(cardContainer.style.height);
        }
    }
</script>
