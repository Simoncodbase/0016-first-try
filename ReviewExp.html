<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bitcoin Card Generator</title>
    <!-- Include the required libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.5.4/elliptic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bs58/4.0.1/bs58.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div id="review-card-container" style="width: 300px; height: 200px; position: relative; border: 1px solid #000; background-color: grey;">
        <!-- The card content will be displayed here -->
    </div>

    <!-- Image after the review-card-container -->
    <img src="https://images.squarespace-cdn.com/content/v1/66cd4946bea1c563dc862564/af009904-2d2e-4cef-94be-d8e172f1e00f/specimen.png?format=1500w" alt="Bitcoin Sample Card" style="width: 300px; height: 200px; display: block; margin-top: 20px;">

    <!-- Container to display the generated addresses and QR codes -->
    <div id="bitcoin-addresses-container" style="margin-top: 20px;">
        <!-- The generated addresses and QR codes will be displayed here -->
    </div>

    <!-- Generate Bitcoin Addresses Button -->
    <button onclick="generateBitcoinAddresses()" style="margin-top: 20px;">Generate Bitcoin Addresses</button>

    <!-- Back to Edit Card Button -->
    <button onclick="backToEditCard()" style="margin-top: 20px;">Back to Edit Card</button>

    <!-- Pay Button -->
    <button onclick="redirectToPayment()" style="margin-top: 20px;">Pay</button>

    <script>
        // Function to load the card content from localStorage and display it
        function loadCard() {
            const cardHTML = localStorage.getItem('cardHTML');

            if (cardHTML) {
                const reviewCardContainer = document.getElementById('review-card-container');
                reviewCardContainer.innerHTML = cardHTML;
            } else {
                console.error('No card data found in localStorage');
            }
        }

        // Function to generate Bitcoin addresses and QR codes without external Bitcoin libraries
        function generateBitcoinAddresses() {
            try {
                // Generate private key using elliptic
                var EC = elliptic.ec;
                var ec = new EC('secp256k1');
                var keyPair = ec.genKeyPair();
                var privateKeyHex = keyPair.getPrivate('hex');

                // Convert private key to WIF
                var privateKeyWIF = wifEncode(privateKeyHex);

                // Get public key
                var publicKey = keyPair.getPublic(true, 'hex');

                // Generate public address
                var publicKeyBuffer = CryptoJS.enc.Hex.parse(publicKey);
                var hash = CryptoJS.SHA256(publicKeyBuffer);
                var ripemd160 = CryptoJS.RIPEMD160(hash);
                var publicKeyHash = ripemd160.toString();

                // Add network byte
                var networkByte = '00' + publicKeyHash;

                // Double SHA256 hash for checksum
                var checksumFull = CryptoJS.SHA256(CryptoJS.SHA256(CryptoJS.enc.Hex.parse(networkByte))).toString();
                var checksum = checksumFull.substr(0, 8);

                // Create the address
                var addressHex = networkByte + checksum;
                var address = bs58.encode(Buffer.from(addressHex, 'hex'));

                // Display the private key and public address
                var container = document.getElementById('bitcoin-addresses-container');
                container.innerHTML = ''; // Clear previous content

                // Display private key
                var privateKeyLabel = document.createElement('p');
                privateKeyLabel.textContent = 'Private Key (WIF):';
                container.appendChild(privateKeyLabel);

                var privateKeyText = document.createElement('p');
                privateKeyText.textContent = privateKeyWIF;
                container.appendChild(privateKeyText);

                // Display public address
                var publicKeyLabel = document.createElement('p');
                publicKeyLabel.textContent = 'Public Address:';
                container.appendChild(publicKeyLabel);

                var publicKeyText = document.createElement('p');
                publicKeyText.textContent = address;
                container.appendChild(publicKeyText);

                // Generate QR codes
                var privateKeyQRContainer = document.createElement('div');
                var publicKeyQRContainer = document.createElement('div');

                container.appendChild(privateKeyQRContainer);
                container.appendChild(publicKeyQRContainer);

                // Generate QR code for private key
                new QRCode(privateKeyQRContainer, {
                    text: privateKeyWIF,
                    width: 128,
                    height: 128,
                });

                // Generate QR code for public address
                new QRCode(publicKeyQRContainer, {
                    text: address,
                    width: 128,
                    height: 128,
                });
            } catch (error) {
                console.error('Error generating Bitcoin addresses:', error);
                alert('Error generating Bitcoin addresses: ' + error.message);
            }
        }

        // Helper function to encode private key to WIF
        function wifEncode(privateKeyHex) {
            // Add network byte
            var step1 = '80' + privateKeyHex;

            // Double SHA256 hash for checksum
            var step2 = CryptoJS.SHA256(CryptoJS.enc.Hex.parse(step1));
            var step3 = CryptoJS.SHA256(step2);
            var checksum = step3.toString().substr(0, 8);

            // Append checksum to step1
            var step4 = step1 + checksum;

            // Convert to Buffer and encode in Base58
            var privateKeyWIF = bs58.encode(Buffer.from(step4, 'hex'));
            return privateKeyWIF;
        }

        // Function to go back to the home page for editing
        function backToEditCard() {
            window.location.href = '/'; // Redirect back to the home page
        }

        // Function to redirect to the payment page
        function redirectToPayment() {
            window.location.href = '/final'; // Redirect to the "Final" page
        }

        // Call the loadCard function on page load
        window.onload = loadCard;
    </script>
</body>
</html>
